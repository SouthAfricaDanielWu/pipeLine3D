using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Configuration;
using SuperMap.Data;
using SuperMap.Realspace;
using SuperMap.UI;
using SQL;
using System.Diagnostics;

namespace NorthStar.Pipeline
{
    public partial class FrmMain : DevExpress.XtraBars.Ribbon.RibbonForm
    {
        #region 变量声明
        int mOpencount = 0;
        private SceneControl mSceneControl;
        private Workspace mWorkspace;
        private SpaceAnalysis mSpaceAnalys;
        private WorkspaceControl mWorkspaceControl;
        private LayersControl mLayersControl;
        private MapControl mMapControl;
        private MapNavigationControl mMapNavigationControl;
        private ManualEdit mManualEdit;
        private InformationBubble mInformationBubble;
   
        private UseData mData;
        private QuickQuery mQuickQuery;
        private SQLQuery mSQLQuery;
        private Query mQuery;
        private MeasureAnalysis mAna;
        private PureDistance mPureDis;
        private SectionAnalysis mSectionAnalys;
        private PipeNetworkAnalysis mPipeNetworkAnalysis;
        private int mIndex;
        #endregion

        public FrmMain()
        {
            //开启反走样
            SuperMap.Data.Environment.IsSceneAntialias = true;
            SuperMap.Data.Environment.SceneAntialiasValue = 8;
            InitializeComponent();

            Initialize();
        }

        private void frmMain_Load(object sender, EventArgs e)
        {
            Configuration config = ConfigurationManager.OpenExeConfiguration(ConfigurationUserLevel.None);
            //defaultLookAndFeel.LookAndFeel.SkinName = config.AppSettings.Settings["SkinName"].Value;
            
            PnlLayoutControl.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Hidden;
            PnlCheckR.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Hidden;
            PnlExcavationAnalysis.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Hidden;
            PnlBufferQuery.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Hidden;
            PnlSpaceQuery.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Hidden;
            PnlBoomAnalysis.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Hidden;
            PnlQueryRusult.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Hidden;
        }
        private void Initialize()
        {
            mWorkspace = new Workspace();
            
            mMapControl = new MapControl();//构造一个新的地图控件
            mMapControl.Action = SuperMap.UI.Action.Select;
            mMapControl.Bounds = new Rectangle(2, 28, 542, 517);//x,y,width,high 控件（包括其非工作区元素）相对于其父控件的大小和位置
            mMapControl.Dock = DockStyle.Fill;//指针的停靠方式为边缘
            mMapControl.Map.Workspace = mWorkspace;//绑定地图控件的工作空间
            TabControl_1.TabPages[0].Controls.Add(mMapControl);
            
            mSceneControl = new SceneControl();//三维地图控件
            mSceneControl.Action = Action3D.Pan2;
            mSceneControl.Dock = DockStyle.Fill;
            mSceneControl.Bounds = new Rectangle(2, 28, 542, 517);
            TabControl_1.TabPages[1].Controls.Add(mSceneControl);
                     
            mInformationBubble = new InformationBubble();
            mInformationBubble.Visible = false;
            this.mSceneControl.Controls.Add(mInformationBubble);

            mMapNavigationControl = new MapNavigationControl();//地图导航控件
            mMapNavigationControl.MapControl = mMapControl;//与bd_mapControl相关联
            mMapNavigationControl.Anchor = AnchorStyles.Top | AnchorStyles.Right;//控件锚定到上边缘和右边缘
            mMapNavigationControl.Location = new Point(mMapControl.Width - 90, 20);//左上角相对坐标

            mWorkspaceControl = new WorkspaceControl(mWorkspace);// 工作空间管理器。 
            mWorkspaceControl.Dock = DockStyle.Fill;
            LayoutsplitContainer.Panel1.Controls.Add(mWorkspaceControl);

            mLayersControl = new LayersControl();//图层管理器，用来展现和管理其所关联的地图或者场景中的图层。
            mLayersControl.Dock = DockStyle.Fill;
            LayoutsplitContainer.Panel2.Controls.Add(mLayersControl);

            InitializeBrowseTools();//初始化二维浏览工具
            InitializeBrowseTools3D();//初始化三维浏览工具

            mData = new UseData(mWorkspaceControl, mSceneControl, mMapControl, mLayersControl,dataGridView1,mInformationBubble);
            mQuery = new Query(mSceneControl, mData, dataGridView1);
            mSpaceAnalys = new SpaceAnalysis(mSceneControl, bd_textBoxTotalArea, bd_textBoxTotalsqure, bd_dataGridViewResult, bd_dataGridViewEdge, bd_textBoxPipeLineID, mInformationBubble, mData);
            mManualEdit = new ManualEdit(mWorkspace, mMapControl);
            mPipeNetworkAnalysis = new PipeNetworkAnalysis(mSceneControl, mData, mInformationBubble);
            mQuickQuery = new QuickQuery(mSceneControl,dataGridAttitu);
            mData.FlyTo(10000000, 116.46, 39.92, 15);
        }

        #region 二维空间初始化
        /// <summary>
        /// 二维控件初始化
        /// </summary>
        private void InitializeBrowseTools()
        {
            try
            {
                ToolStrip toolStripBrowseTools = new ToolStrip();
                toolStripBrowseTools.GripStyle = ToolStripGripStyle.Hidden;

                //....................地图浏览控件..........................
                ToolStripButton toolStripButtonSelect = new ToolStripButton();
                ToolStripButton toolStripButtonPan = new ToolStripButton();
                ToolStripButton toolStripButtonZoomIn = new ToolStripButton();
                ToolStripButton toolStripButtonZoomOut = new ToolStripButton();
                ToolStripButton toolStripButtonZoomFree = new ToolStripButton();
                ToolStripButton toolStripButtonViewEntire = new ToolStripButton();
                ToolStripButton toolStripButtonRefresh = new ToolStripButton();


                // comboBoxDrawSelect.Items.AddRange(new string[]{ "点", "线", "面", "文本" 
                //   });
                //comboBoxDrawSelect.SelectedIndex = 0;

                //添加到toolStripBrowseTools中
                toolStripBrowseTools.Items.AddRange(new System.Windows.Forms.ToolStripItem[] {
                toolStripButtonSelect,
                toolStripButtonPan,
                toolStripButtonZoomIn,
                toolStripButtonZoomOut,
                toolStripButtonZoomFree,
                toolStripButtonViewEntire,
                toolStripButtonRefresh,
                });

                //------------------地图浏览控件事件注册--------------------------//
                toolStripButtonSelect.ToolTipText = "选择";
                toolStripButtonSelect.Image = Properties.Resources.MapSelect;
                toolStripButtonSelect.Click += new EventHandler(toolStripButtonSelect_Click);

                toolStripButtonPan.ToolTipText = "漫游";
                toolStripButtonPan.Image = Properties.Resources.MapPan;
                toolStripButtonPan.Click += new EventHandler(toolStripButtonPan_Click);


                toolStripButtonZoomIn.ToolTipText = "放大";
                toolStripButtonZoomIn.Image = Properties.Resources.MapZoomIn;
                toolStripButtonZoomIn.Click += new EventHandler(toolStripButtonZoomIn_Click);

                toolStripButtonZoomOut.ToolTipText = "缩小";
                toolStripButtonZoomOut.Image = Properties.Resources.MapZoomOut;
                toolStripButtonZoomOut.Click += new EventHandler(toolStripButtonZoomOut_Click);

                toolStripButtonZoomFree.ToolTipText = "自由缩放";
                toolStripButtonZoomFree.Image = Properties.Resources.MapZoomFree;
                toolStripButtonZoomFree.Click += new EventHandler(toolStripButtonZoomFree_Click);

                toolStripButtonViewEntire.ToolTipText = "全幅显示";
                toolStripButtonViewEntire.Image = Properties.Resources.MapEntire;
                toolStripButtonViewEntire.Click += new EventHandler(toolStripButtonViewEntire_Click);

                toolStripButtonRefresh.ToolTipText = "刷新";
                toolStripButtonRefresh.Image = Properties.Resources.MapRefresh;
                toolStripButtonRefresh.Click += new EventHandler(toolStripButtonRefresh_Click);

                toolStripButtonRefresh.ToolTipText = "关闭";
                toolStripButtonRefresh.Image = Properties.Resources.MapClose;
                toolStripButtonRefresh.Click += new EventHandler(toolStripButtonClose_Click);

                TabControl_1.TabPages[0].Controls.Add(toolStripBrowseTools);//把toolStripBrowseTools加入到第一个选项卡集合中

                toolStripBrowseTools.SendToBack();//把控件发送到Z顺序后
                toolStripBrowseTools.Dock = DockStyle.Top;//停靠顶端
            }
            catch (Exception ex)
            {
                Trace.WriteLine(ex.Message);
            }
        }
        #endregion

        #region 二维控件上的编辑事件
        /// <summary>
        /// 选择事件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonSelect_Click(object sender, EventArgs e)
        {
            mMapControl.Action = SuperMap.UI.Action.Select;
        }

        /// <summary>
        /// 漫游事件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonPan_Click(object sender, EventArgs e)
        {
            mMapControl.Action = SuperMap.UI.Action.Pan;
        }

        /// <summary>
        /// 放大
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonZoomIn_Click(object sender, EventArgs e)
        {
            mMapControl.Action = SuperMap.UI.Action.ZoomIn;
        }
        /// <summary>
        /// 缩小
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonZoomOut_Click(object sender, EventArgs e)
        {
            mMapControl.Action = SuperMap.UI.Action.ZoomOut;
        }
        /// <summary>
        /// 自由缩放
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonZoomFree_Click(object sender, EventArgs e)
        {
            mMapControl.Action = SuperMap.UI.Action.ZoomFree;
        }
        /// <summary>
        /// 全幅显示地图
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonViewEntire_Click(object sender, EventArgs e)
        {
            mMapControl.Map.ViewEntire();
        }
        /// <summary>
        /// 刷新
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonRefresh_Click(object sender, EventArgs e)
        {
            mMapControl.Map.Refresh();
        }
        /// <summary>
        /// 关闭
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonClose_Click(object sender, EventArgs e)
        {
            mMapControl.Map.Close();
        }
        #endregion

        #region 三维控件初始化
        /// <summary>
        /// 三维控件初始化
        /// </summary>
        private void InitializeBrowseTools3D()
        {
            ToolStrip toolStripBrowseTools3D = new ToolStrip();
            toolStripBrowseTools3D.GripStyle = ToolStripGripStyle.Hidden;

            ToolStripButton toolStripButtonSelect3D = new ToolStripButton();
            ToolStripButton toolStripButtonPan3D = new ToolStripButton();
            ToolStripButton toolStripButtonRefresh3D = new ToolStripButton();
            ToolStripButton toolStripButtonViewEntire3D = new ToolStripButton();

            toolStripBrowseTools3D.Items.AddRange(new System.Windows.Forms.ToolStripItem[] {
                toolStripButtonSelect3D,
                toolStripButtonPan3D,
                toolStripButtonViewEntire3D,
                toolStripButtonRefresh3D});

            toolStripButtonSelect3D.ToolTipText = "选择";
            toolStripButtonSelect3D.Image = Properties.Resources.SceneSelect;
            toolStripButtonSelect3D.Click += new EventHandler(bd_toolStripViewTools3D_Click);

            toolStripButtonPan3D.ToolTipText = "选择漫游";
            toolStripButtonPan3D.Image = Properties.Resources.ScenePan;
            toolStripButtonPan3D.Click += new EventHandler(toolStripButtonPan3D_Click);

            toolStripButtonViewEntire3D.ToolTipText = "全球";
            toolStripButtonViewEntire3D.Image = Properties.Resources.SceneViewEntire;
            toolStripButtonViewEntire3D.Click += new EventHandler(toolStripButtonViewEntire3D_Click);

            toolStripButtonRefresh3D.ToolTipText = "刷新";
            toolStripButtonRefresh3D.Image = Properties.Resources.SceneRefresh;
            toolStripButtonRefresh3D.Click += new EventHandler(toolStripButtonRefresh3D_Click);

            toolStripButtonRefresh3D.ToolTipText = "关闭";
            toolStripButtonRefresh3D.Image = Properties.Resources.MapClose;
            toolStripButtonRefresh3D.Click += new EventHandler(toolStripButtonClose3D_Click);

            TabControl_1.TabPages[1].Controls.Add(toolStripBrowseTools3D);
            toolStripBrowseTools3D.SendToBack();
            toolStripBrowseTools3D.Dock = DockStyle.Top;
        }
        #endregion

        #region 三维控件编辑事件
        /// <summary>
        /// 选择事件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void bd_toolStripViewTools3D_Click(object sender, EventArgs e)
        {
            mSceneControl.Action = Action3D.Select;
        }
        /// <summary>
        /// 漫游事件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonPan3D_Click(object sender, EventArgs e)
        {
            mSceneControl.Action = Action3D.Pan2;
        }
        /// <summary>
        /// 全球事件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonViewEntire3D_Click(object sender, EventArgs e)
        {
            mSceneControl.Scene.ViewEntire();
        }
        /// <summary>
        /// 刷新事件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonRefresh3D_Click(object sender, EventArgs e)
        {
            mSceneControl.Scene.Refresh();
        }
        /// <summary>
        /// 关闭事件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonClose3D_Click(object sender, EventArgs e)
        {
            //bd_sceneControl.Scene.Close();
            try 
            { 
                mAna.ClearResult();                
            }
            catch(Exception ex)
            {
                Trace.WriteLine(ex.Message);
            }
        }
        #endregion

        /// <summary>
        /// 打开工作空间
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void btnLWSpace_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
           if (mSceneControl.Controls.Count == mOpencount)
            {
                mData = new UseData(mWorkspaceControl, mSceneControl,mMapControl,mLayersControl,dataGridView1,mInformationBubble);
                mData.OpenWorkSpace();
                mOpencount+=2;
            }
            else
            {
                this.mSceneControl.Action = Action3D.Pan2;
                this.mWorkspace.Close();
                this.mData.OpenWorkSpace();
                //this.mSceneControl.Scene.ViewEntire();
                this.mSceneControl.Scene.Refresh();
            }
           //mData.OpenPipe();
           //mData.BuildNet();
        }
        /// <summary>
        /// 打开图层管理窗口
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void btnLManger_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            PnlLayoutControl.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;
        }
        /// <summary>
        /// 窗体关闭事件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void frmMain_FormClosing(object sender, FormClosingEventArgs e)
        {
            if (mMapNavigationControl != null)
            {
                mMapNavigationControl.Dispose();
            }
            if (mSceneControl != null)
            {
                mInformationBubble.Dispose();
                mSceneControl.Dispose();
            }
            if (mMapControl != null)
            {
                mMapControl.Dispose();
            }
            mWorkspaceControl.Dispose();
            mLayersControl.Dispose();
            mWorkspace.Dispose();
        }

        private void btnHDistance_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mAna = new MeasureAnalysis(this.mSceneControl,this);
            mAna.BeginMeasureDistance();
        }

        private void btnVDistance_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mAna = new MeasureAnalysis(this.mSceneControl,this);
            mAna.BeginMeasureAltitude();
        }

        #region 属性查询
        private void btnCProperty_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            if (PnlCheckR.Visibility != DevExpress.XtraBars.Docking.DockVisibility.Visible)
            {
                PnlCheckR.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;
            }
            mIndex = 1;
            mQuickQuery.AttMouseEvent(mIndex);
        }
        #endregion

        private void TabControl_1_SelectedPageChanged(object sender, DevExpress.XtraTab.TabPageChangedEventArgs e)
        {
            if (TabControl_1.SelectedTabPageIndex == 0)
            {
                mLayersControl.Map = mMapControl.Map;
                mData.ViewIndex = 0;
            }
            else
            {
                mLayersControl.Scene = mSceneControl.Scene;
                mData.ViewIndex = 1;
            }
        }

        /// <summary>
        /// 点按钮编辑方式
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void barpoint_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            buttonPoint.Enabled = true;

            buttonLine.Enabled = false;
            button1PolyLine.Enabled = false;
            buttonFreeLine.Enabled = false;
            buttonCurve.Enabled = false;
            buttonParallel.Enabled = false;

            buttonPolygon.Enabled = false;
            buttonRectangle.Enabled = false;
            buttonRoundRectangle.Enabled = false;
            button3pCircle.Enabled = false;
            buttonParallelogram.Enabled = false;

            buttonText.Enabled = false;
            buttonLineText.Enabled = false;

            buttonVertexAdd.Enabled = false;
            buttonVertexEdit.Enabled = false;
        }

        /// <summary>
        /// 线按钮编辑方式
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void barCheckItem3_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            buttonPoint.Enabled = false;
            //线 true
            buttonLine.Enabled = true;
            button1PolyLine.Enabled = true;
            buttonFreeLine.Enabled = true;
            buttonCurve.Enabled = true;
            buttonParallel.Enabled = true;
            //画多边形  true
            buttonPolygon.Enabled = true;
            buttonRectangle.Enabled = true;
            buttonRoundRectangle.Enabled = true;
            button3pCircle.Enabled = true;
            buttonParallelogram.Enabled = true;
            //文本 FALSE
            buttonText.Enabled = false;
            buttonLineText.Enabled = false;
            //添加节点 true
            buttonVertexAdd.Enabled = true;
            buttonVertexEdit.Enabled = true;

            mManualEdit.DrawLine();//调方法 画线
        }

        /// <summary>
        /// 多边形按钮编辑方式
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void barCheckItem5_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            buttonPoint.Enabled = false;

            buttonLine.Enabled = false;
            button1PolyLine.Enabled = false;
            buttonFreeLine.Enabled = false;
            buttonCurve.Enabled = false;
            buttonParallel.Enabled = false;
            //线
            buttonPolygon.Enabled = true;
            buttonRectangle.Enabled = true;
            buttonRoundRectangle.Enabled = true;
            button3pCircle.Enabled = true;
            buttonParallelogram.Enabled = true;

            buttonText.Enabled = false;
            buttonLineText.Enabled = false;
            //节点
            buttonVertexAdd.Enabled = true;
            buttonVertexEdit.Enabled = true;

            mManualEdit.DrawRegion();//画多边形
        }

        /// <summary>
        /// 文本按钮编辑方式
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void barCheckItem4_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            buttonPoint.Enabled = false;

            buttonLine.Enabled = false;
            button1PolyLine.Enabled = false;
            buttonFreeLine.Enabled = false;
            buttonCurve.Enabled = false;
            buttonParallel.Enabled = false;

            buttonPolygon.Enabled = false;
            buttonRectangle.Enabled = false;
            buttonRoundRectangle.Enabled = false;
            button3pCircle.Enabled = false;
            buttonParallelogram.Enabled = false;
            //文本可见
            buttonText.Enabled = true;
            buttonLineText.Enabled = true;

            buttonVertexAdd.Enabled = false;
            buttonVertexEdit.Enabled = false;
            mManualEdit.DrawText();//画文本
        }

        #region 编辑事件按钮
        private void buttonPoint_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreatePoint);
        }
        private void buttonLine_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreateLine);
        }

        private void button1PolyLine_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreatePolyline);
        }

        private void buttonFreeLine_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreateFreePolyline);
        }

        private void buttonCurve_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreateCurve);
        }

        private void buttonParallel_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreateParallel);
        }

        private void buttonPolygon_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreatePolygon);
        }

        private void buttonRectangle_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreateRectangle);
        }

        private void buttonRoundRectangle_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreateRoundRectangle);
        }

        private void buttonParallelograbd_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreateCircle3P);
        }

        private void button3pCircle_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreateParallelogram);
        }

        private void buttonText_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreateText);
        }

        private void buttonLineText_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.CreateAlongLineText);
        }

        private void buttonVertexAdd_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.VertexAdd);//添加节点
        }
     

        private void buttonVertexEdit_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mManualEdit.SetAction(SuperMap.UI.Action.VertexEdit);//编辑节点
            mMapControl.Map.Refresh();
        }
        #endregion

        private void buttonParallelogram_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {

        }

        private void bd_buttonAddExcavationRegion_Click(object sender, EventArgs e)
        {
            try
            {
                if (bd_textBoxDeep.Text != "")
                {
                    mSpaceAnalys.RemoveExcavationRegion();
                    mSpaceAnalys.AddExcavationRegion(bd_textBoxDeep.Text);
                    bd_buttonShowRegion.Enabled = true;
                }
                else
                {
                    MessageBox.Show("请输入底部高程");
                }
            }
            catch (Exception ex)
            {
                Trace.WriteLine(ex.Message);
            }
        }

        private void bd_buttonRemoveExcavationRegion_Click(object sender, EventArgs e)
        {
            mSpaceAnalys.RemoveExcavationRegion();
           // mSpaceAnalys.TargetPoint();
            bd_textBoxDeep.Text = "";
            bd_textBoxTotalArea.Text = "";
            bd_textBoxTotalsqure.Text = "";
            mSceneControl.Scene.GlobalImage.Transparency = 50;
        }

        private void bd_buttonShowRegion_Click(object sender, EventArgs e)
        {
            mSpaceAnalys.ShowTarget();
        }

        private void btnDig_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            PnlExcavationAnalysis.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;
            if (PnlExcavationAnalysis.Visibility ==DevExpress.XtraBars.Docking.DockVisibility.Visible)
                PnlExcavationAnalysis.Visibility = DevExpress.XtraBars.Docking.DockVisibility.AutoHide;
           // mSceneControl.Tracking -= new Tracking3DEventHandler(bd_sceneControl_Tracking);
           // mSceneControl.Tracked -= new Tracked3DEventHandler(bd_sceneControl_Tracked);
        }

        #region 打开缓冲查询窗口
        private void btnCArea_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mSceneControl.Action = Action3D.Select;
            PnlBufferQuery.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;
            PnlQueryRusult.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;
        }
        #endregion

        #region 创建缓冲区
        private void butCreate_Click(object sender, EventArgs e)
        {
            mData.CreateBuffer();
        }
        #endregion

        #region 设置缓冲区半径
        private void textBox1_TextChanged(object sender, EventArgs e)
        {
            Boolean isField = false;
            if (textBox1.Text.Length != 0)
            {
                isField = true;
            }
            mData.SetRadius(textBox1.Text, isField);
        }
        #endregion

        #region 生成的缓冲区进行查询
        private void butQuery_Click(object sender, EventArgs e)
        {
            mData.BufferQuery();
        }
        #endregion

        #region 清除缓冲区
        private void butClear_Click(object sender, EventArgs e)
        {
            this.textBox1.Clear();
            mData.DeleteBuffer();
        }
        #endregion

        #region 打开空间查询窗口
        private void barButtonItem1_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            PnlSpaceQuery.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;          
            PnlQueryRusult.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;
        }
        #endregion

        #region 爆管分析
        private void bd_buttonSelectLine_Click(object sender, EventArgs e)
        {
            mSceneControl.Action = Action3D.Select;
            mSpaceAnalys.SelectPipeLine();
            bd_buttonSelectLine.Enabled = false;
        }

        private void bd_buttonClearSelectLine_Click(object sender, EventArgs e)
        {
            mSpaceAnalys.Clear();
            bd_buttonSelectLine.Enabled = true;
        }

        private void bd_dataGridViewResult_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            mSpaceAnalys.FlyToValve(e.RowIndex);
        }

        private void bd_dataGridViewEdge_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            mSpaceAnalys.FlyToPipe(e.RowIndex);
        }

        private void btnBPoint_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            PnlBoomAnalysis.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;
            if (PnlBoomAnalysis.Visibility == DevExpress.XtraBars.Docking.DockVisibility.Visible)
                PnlBoomAnalysis.Visibility = DevExpress.XtraBars.Docking.DockVisibility.AutoHide;
        }
        #endregion

        private void btnHSection_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mSectionAnalys = new SectionAnalysis(mSceneControl, this,mData);
            mSectionAnalys.BeginSection();          
        }
        #region 阀门控制
        private void mButtonSelectValve_Click(object sender, EventArgs e)
        {
            mSpaceAnalys.SelectLine();
        }

        private void mButtonAnalysisValva_Click(object sender, EventArgs e)
        {
            mSpaceAnalys.AnalysisLine();
            mTextBoxControl.Text = mSpaceAnalys.InfluencePipe.ToString();
            mTextBoxLon.Text = mSpaceAnalys.mAnalongitude.ToString();
            mTextBoxLat.Text = mSpaceAnalys.mAnalatitude.ToString();
        }

        private void mButtonlocateValva_Click(object sender, EventArgs e)
        {
            mSpaceAnalys.FlyToControlPipe();
        }

        private void mButtonClearValva_Click(object sender, EventArgs e)
        {
            mSpaceAnalys.ControlClear();
            mTextBoxControl.Text = "";
            mTextBoxLon.Text = "";
            mTextBoxLat.Text = "";
        }

        private void btnValve_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            if (PanelControlValve.Visibility == DevExpress.XtraBars.Docking.DockVisibility.Visible)
            {
                PanelControlValve.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Hidden;
            }
            else
                PanelControlValve.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;
        }
        #endregion

        #region 显示全幅区域、清除图层和属性表
        private void butShow_Click(object sender, EventArgs e)
        {
            mQuery.TargetPoint();
        }

        private void but_Clearing_Click(object sender, EventArgs e)
        {
            mQuery.ClearTrack();
        }
        #endregion

        #region 矩形空间查询区域事件
        private void butEllipse_Click(object sender, EventArgs e)
        {
            mQuery.AreaQueryEvent();
        }
        #endregion

        #region 圆形区域空间查询
        private void button1_Click(object sender, EventArgs e)
        {
            mSceneControl.Action = Action3D.Select;
            mQuery.CircleEvent();
        }
        #endregion

        #region 矩形区域空间相交、相离查询、包含查询    
        private void button10_Click(object sender, EventArgs e)
        {
            if(radIntersect.Checked)
            {
                mQuery.InsertQuery();
            }
            else if(radContain.Checked)
            {
                mQuery.ContainQuery();
            }
            else if(radSepar.Checked)
            {
                mQuery.SeparQuery();
            }
        }
        #endregion

        #region 流向分析

        private void barButtonItem3_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            
            if (PnlFlowAnalysis.Visibility == DevExpress.XtraBars.Docking.DockVisibility.Visible)
            {
                PnlFlowAnalysis.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Hidden;
            }
            else
                PnlFlowAnalysis.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;
        }

        private void mBtnFlowSelect_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.SelectPoint();
        }

        private void mBtnFlowAnalysis_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.FindSourceAndSink(mPipeNetworkAnalysis.SeachFlag);
            mtextBoxSinkID.Text = mPipeNetworkAnalysis.SinkNode.ToString();
            mtextBoxSinkCost.Text = mPipeNetworkAnalysis.SinkFromNodeCost.ToString("0.0000");
            mtextBoxSourceID.Text = mPipeNetworkAnalysis.SourceNode.ToString();
            mtextBoxSourceCost.Text = mPipeNetworkAnalysis.SourceFromNodeCost.ToString("0.0000");
            mSceneControl.Action = Action3D.Pan2;
        }

        private void mBtnFlowShowSource_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.ShowSourceEdges(mPipeNetworkAnalysis.LayerName);
            mSceneControl.Action = Action3D.Pan2;
        }

        private void mBtnFlowshowSink_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.ShowSinkEdges(mPipeNetworkAnalysis.LayerName);
            mSceneControl.Action = Action3D.Pan2;
        }

        private void mBtnFlowTraceUp_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.TraceUp(mPipeNetworkAnalysis.LayerName);
        }

        private void mBtnFlowTraceDown_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.TraceDown(mPipeNetworkAnalysis.LayerName);
        }

        private void mBtnFlowShowAll_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.ShowAllEdges(mPipeNetworkAnalysis.LayerName);
        }

        private void mBtnFlowClear_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.ClearEdges(mPipeNetworkAnalysis.LayerName);
            mtextBoxSinkID.Text = "";
            mtextBoxSinkCost.Text = "";
            mtextBoxSourceID.Text = "";
            mtextBoxSourceCost.Text = "";
        }
        #endregion
        #region  流通分析
        int flag = 0;
        private MouseEventHandler mSceneMouseQuery8;
        private void barButtonItem2_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            if (PnlConnectAnalysis.Visibility == DevExpress.XtraBars.Docking.DockVisibility.Visible)
            {
                PnlConnectAnalysis.Visibility = DevExpress.XtraBars.Docking.DockVisibility.AutoHide;
            }
            else
                PnlConnectAnalysis.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;

            mGroupBoxJudge.Enabled = false;
            mGroupBoxShow.Enabled = false;
        }

        private void mBtnConnectSelect_Click(object sender, EventArgs e)
        {
            flag += 1;
            if (flag == 1)
            {
                MessageBox.Show("请选择第1个管点");
                mPipeNetworkAnalysis.SelectPoint2(flag);

            }
            else
            {
                MessageBox.Show("请选择第2个管点");
                mPipeNetworkAnalysis.SelectPoint2(flag);

            }
        }

        private void mBtnConnectAnalysis_Click(object sender, EventArgs e)
        {
            if (mPipeNetworkAnalysis.PipeConId2 == 0)
            {
                MessageBox.Show("请选择第二个管点");
            }
            else
            {
                mTextBoxID1.Text = mPipeNetworkAnalysis.PipeConId1.ToString();
                mTextBoxID2.Text = mPipeNetworkAnalysis.PipeConId2.ToString();
                mPipeNetworkAnalysis.ConenectJudge(mPipeNetworkAnalysis.PipeConId1);
                if (mPipeNetworkAnalysis.ConnectFlag == 1)
                {
                    mTextBoxResult.Text = "相互连通";
                }
                else if (mPipeNetworkAnalysis.ConnectFlag == 0)
                {
                    mTextBoxResult.Text = "不连通";
                }
                mPipeNetworkAnalysis.ConnectShow();
            }
        }

        private void mBtnLocateID1_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.FlyToConnectID(1, mPipeNetworkAnalysis.PipeConId1);
        }

        private void mBtnLocateID2_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.FlyToConnectID(2, mPipeNetworkAnalysis.PipeConId2);
        }

        private void mBtnConnectClear1_Click(object sender, EventArgs e)
        {
            mTextBoxID1.Text = "";
            mTextBoxID2.Text = "";
            mTextBoxResult.Text = "";
            mPipeNetworkAnalysis.ConnectFlag = 0;
           // mPipeNetworkAnalysis.ClearEdges();
            mSceneControl.Bubbles.Clear();
            flag = 0;
        }

        private void mBtnConnectSelect2_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.SelectPoint();
        }

        private void mBtnConnectShow_Click(object sender, EventArgs e)
        {
            mPipeNetworkAnalysis.ConnectAnalysis();
            mTextBoxID.Text = mPipeNetworkAnalysis.PipeId1.ToString();
        }

        private void mBtnConnectClear2_Click(object sender, EventArgs e)
        {
            //mPipeNetworkAnalysis.ClearEdges();
            mTextBoxID.Text = "";
        }

        private void mComboBoxAnalysis_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (mComboBoxAnalysis.SelectedIndex == 0)
            {
                mGroupBoxJudge.Enabled = true;
                mGroupBoxShow.Enabled = false;
            }
            else if (mComboBoxAnalysis.SelectedIndex == 1)
            {
                mGroupBoxShow.Enabled = true;
                mGroupBoxJudge.Enabled = false;
            }
        }

        #endregion

        #region 地形透明和地下浏览
        private void btnLView_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            if (this.panel2.Visible == true)
            {
                this.panel2.Visible = false;
                return;
            }
            this.panel2.Visible = true;
        }
        private void trackTran_Scroll(object sender, EventArgs e)
        {
            mSceneControl.Scene.GlobalImage.Transparency = trackTran.Value;
        }        
        private void btnVUnder_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            Layer3Ds mLayer=mSceneControl.Scene.Layers;
            foreach(Layer3D layer in mLayer)
            {
                string str = layer.Name;
                if (str == "绿地@guilinligong" || str == "SCHOOLIMAGE@guilinligong" || str == "schoolbuilding02@guilinligong"
                    || str == "道路断线_3D@guilinligong#1" || str == "道路断线_3D@guilinligong" || str == "水面@guilinligong" || str == "绿树点@guilinligong")
                {
                    if(layer.IsVisible==true)
                    {
                        layer.IsVisible = false;
                    }
                    else
                    {
                        layer.IsVisible = true;
                    }
                }
            }
        }
        #endregion

        #region 构建管网
        private void barButtonItem5_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mData.BuildNet2("排水管点_3D", "排水管线_3D", "排水管网", 0, 965565, Color.White);
            mData.BuildNet2("给水管点_3D", "给水管线_3D", "给水管网", 1, 965564, Color.Red);
            mData.CreateRegion();
            MessageBox.Show("三维网络数据集构建成功！");
        }
        #endregion

        #region 点击查询表格发生的事件
        private void dataGridView1_CellClick_1(object sender, DataGridViewCellEventArgs e)
        {
            mData.FlyToLine(e.RowIndex);
        }
        #endregion

        #region SQL查询
        private void btnCSpace_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            PnlQueryRusult.Visibility = DevExpress.XtraBars.Docking.DockVisibility.Visible;
            mSQLQuery = new SQLQuery(mWorkspace, mSceneControl, mData, dataGridView1);
            mSQLQuery.ShowDialog();
        }
        #endregion

        #region 权属查询
        private void btnCOwner_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mIndex = 2;
            mSceneControl.Action = Action3D.Select;
            mQuickQuery.OwnerEvent(mIndex);      
        }
        #endregion

        #region 单位查询
        private void btnCDepartment_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mIndex = 3;
            mSceneControl.Action = Action3D.Select;
            mQuickQuery.UnitsEvent(mIndex);         
        }
        #endregion

        #region 材质查询
        private void btnCMaterial_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mIndex = 4;
            mSceneControl.Action = Action3D.Select;
            mQuickQuery.MaterEvent(mIndex);    
        }
        #endregion

        #region 测区查询
        private void btnCSurveyArea_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mIndex = 5;
            mSceneControl.Action = Action3D.Select;
            mQuickQuery.MeasureEvent(mIndex);
        }
        #endregion

        #region 管径查询
        private void btnCPipeW_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mIndex = 6;
            mSceneControl.Action = Action3D.Select;
            mQuickQuery.DiametEvent(mIndex);
        }
        #endregion

        #region 附属物查询
        private void btnCEquipment_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mIndex = 7;
            mSceneControl.Action = Action3D.Select;
            mQuickQuery.AppendEvent(mIndex);
        }
        #endregion

<<<<<<< HEAD
        #region 统计功能
        private void btnSpaceCount_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            LengthStatistics mLengthStatis = new LengthStatistics(mSceneControl);
            mLengthStatis.ShowDialog();
        }
=======
        #region 净距分析
        private void btnAbsHDistance_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            mPureDis = new PureDistance(mSceneControl,this,mData);
            //mPureDis.GetHResult();
        }

        private void btnAbsVDistance_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {

        }

        private void btnCover_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {

        }

>>>>>>> e06247c79fd6160833beec0d78c0564b69f4c69a
        #endregion
    }
}
